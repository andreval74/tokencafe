<!DOCTYPE html>
<html lang="pt-BR">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Widget de Teste - TokenCafe</title>
  <meta name="description" content="Widget de venda de tokens com fluxo guiado">
  <meta name="keywords" content="widget, venda, tokens, MetaMask, BSC Testnet">
  <meta name="author" content="TokenCafe Team">
  <meta http-equiv="Content-Security-Policy"
    content="script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net https://cdnjs.cloudflare.com; object-src 'none'; base-uri 'self';">
  <link rel="icon" type="image/png" sizes="16x16" href="../../../imgs/tkncafe16x16.png">
  <link rel="icon" type="image/png" sizes="32x32" href="../../../imgs/tkncafe32x32.png">
  <link rel="icon" type="image/png" sizes="192x192" href="../../../imgs/tkncafe192x192.png">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
    rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="../../../css/styles.css" rel="stylesheet">
</head>

<body class="bg-page-black">
  <div data-component="tools-header.html" data-icon="fa-rocket" data-icon-alt="Mini Widget"
    data-title="Widget de Venda de Tokens" data-subtitle="Fluxo guiado para verificação de contratos">
  </div>
  
  <div class="container-fluid py-3 md-1">
    <div class="row justify-content-center">
      <div class="col-lg-8 col-xl-6">
        <!-- Passo 1: Conectar MetaMask -->
        <div class="card mb-3 d-none">
          <div class="card-header">
            <span><i class="bi bi-wallet2 me-2"></i>Passo 1: Conectar MetaMask</span>
          </div>
          <div class="card-body">
            <button id="connectWallet" class="btn btn-outline-secondary w-100 mb-2">🔗 Conectar MetaMask</button>
          </div>
        </div>

        <!-- Passo 2: Carregar RPC e ABIs -->
        <div class="card mb-3">
          <div class="card-header">
            <span><i class="bi bi-gear me-2"></i>Passo 2: Carregar RPC e ABIs</span>
          </div>
          <div class="card-body">
            <form id="checkerForm">
              <div class="row g-2">
                <!-- Busca de Rede Blockchain (reutilizável) -->
                <div class="col-12 mb-4">
                  <label for="networkSearch" class="form-label">
                    <i class="bi bi-search me-2"></i>Buscar Rede Blockchain
                  </label>

                  <div class="input-group position-relative">
                    <input id="networkSearch" class="form-control" placeholder="Digite o nome da rede ou Chain ID (ex: Ethereum, Polygon, 1, 137)">
                    <button id="networkDetailsBtn" type="button" class="btn btn-outline-info"
                      title="Ver informações do Token" data-bs-toggle="tooltip" data-bs-placement="top">
                      <i class="bi bi-info-circle"></i>
                    </button>
                    
                    <div id="networkAutocomplete" class="network-autocomplete position-absolute w-100 d-none">
                      <!-- Resultados da busca aparecerão aqui -->
                    </div>
                  </div>

                  <!-- Informações da rede selecionada (opcional, estilo Link) -->
                  <div id="selected-network-info" class="card mt-2 collapse">
                    <div class="card-body">
                      <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0">Rede Selecionada</h6>
                        <button id="btnClearNetworkSelection" type="button" class="btn btn-sm btn-outline-secondary"
                          title="Limpar seleção">
                          <i class="bi bi-x-circle"></i>
                        </button>
                      </div>
                      <div class="row g-2">
                        <div class="col-md-6"><span>Nome:</span> <code id="networkNameCode"></code></div>
                        <div class="col-md-6"><span>Chain ID:</span> <code id="chainIdCode"></code></div>
                        <div class="col-md-6"><span>Moeda nativa:</span> <code id="nativeCurrencyNameCode"></code></div>
                        <div class="col-md-6"><span>Símbolo:</span> <code id="nativeCurrencySymbolCode"></code></div>
                        <div class="col-md-6">
                          <span>Explorer:</span>
                          <a id="explorerUrlText" href="#" target="_blank" rel="noopener"
                            class="text-decoration-none text-tokencafe">
                            <span id="explorerUrlCode"></span>
                          </a>
                        </div>
                      </div>
                      <div id="metamaskNetworkAlert"
                        class="alert alert-warning d-none mt-2 d-flex align-items-center justify-content-between">
                        <div>
                          <i class="bi bi-exclamation-triangle me-2"></i>
                          Sua carteira está em outra rede. Altere para <span id="metamaskTargetName"></span> (Chain ID:
                          <span id="metamaskTargetId"></span>).
                        </div>
                        <button id="metamaskSwitchBtn" type="button" class="btn btn-sm btn-outline-warning">
                          Trocar rede
                        </button>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="col-12 mb-4">
                  <label class="form-label">Contrato Token (SCAFE)</label>
                  <div class="input-group position-relative">
                    <input id="tokenContract" class="form-control" value="0x2cf724171a998C3d470048AC2F1b187a48A5cafE"
                      required>
                    <button id="tokenContractInfoBtn" class="btn btn-outline-info" type="button"
                      title="Ver informações do Token" data-bs-toggle="tooltip" data-bs-placement="top">
                      <i class="bi bi-info-circle"></i>
                    </button>
                  </div>

                </div>
                <div id="fieldBalance_tokenContract" class="small text-muted field-info collapse mt-2"></div>
              </div>
              <div class="col-12 mb-4">
                <label class="form-label">Contrato Sale</label>
                <div class="input-group position-relative">
                  <input id="saleContract" class="form-control" value="0x2701B4ef482BE4DD8A653B7C97090713A9a0AFE6"
                    required>
                  <button id="saleContractInfoBtn" class="btn btn-outline-info" type="button"
                    title="Ver informações do Contrato Sale" data-bs-toggle="tooltip" data-bs-placement="top">
                    <i class="bi bi-info-circle"></i>
                  </button>
                </div>
                <div id="fieldBalance_saleContract" class="small text-muted field-info collapse"></div>
              </div>
              <div class="col-12 mb-4">
                <label class="form-label">Carteira Comprador</label>
                <div class="input-group position-relative">
                  <input id="buyerWallet" class="form-control" value="0x0b81337F18767565D2eA40913799317A25DC4bc5"
                    required>
                  <button id="buyerWalletInfoBtn" class="btn btn-outline-info" type="button"
                    title="Ver informações da Carteira do Comprador" data-bs-toggle="tooltip" data-bs-placement="top">
                    <i class="bi bi-info-circle"></i>
                  </button>
                </div>
                <div id="fieldBalance_buyerWallet" class="small text-muted field-info collapse"></div>
              </div>
              <div class="col-12 mb-4">
                <label class="form-label">Carteira Recebedor</label>
                <div class="input-group position-relative">
                  <input id="receiverWallet" class="form-control" value="0xEe02E32d8d2888E9f1D6d13391E716Bc7F41f6Ae"
                    required>
                  <button id="receiverWalletInfoBtn" class="btn btn-outline-info" type="button"
                    title="Ver informações da Carteira do Recebedor" data-bs-toggle="tooltip" data-bs-placement="top">
                    <i class="bi bi-info-circle"></i>
                  </button>
                </div>
                <div id="fieldBalance_receiverWallet" class="small text-muted field-info collapse"></div>
              </div>
              <div class="col-12">
                <label class="form-label">ABI Token (JSON)</label>
                <textarea id="tokenAbiText" class="form-control font-monospace" rows="8"></textarea>
              </div>
              <div class="col-12">
                <label class="form-label">ABI Sale (JSON)</label>
                <textarea id="saleAbiText" class="form-control font-monospace" rows="8"></textarea>
              </div>
          </div>
          <button type="submit" class="btn btn-success w-100 mt-2">🚀 Rodar Checagens</button>

          </form>
        </div>
      </div>

      <!-- Passo 3: Verificar Saldo do Contrato Sale -->
      <div class="card mb-3 d-none">
        <div class="card-header">
          <span><i class="bi bi-clipboard-data me-2"></i>Passo 3: Verificar Saldo do Contrato Sale</span>
        </div>
        <div class="card-body">
          <button id="checkBalance" class="btn btn-outline-warning w-100 mb-2 d-none">📊 Verificar Saldo do Contrato
            Sale</button>
          <div id="balanceLoading" class="d-none small text-muted mb-2">
            <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
            Pesquisando saldos...
          </div>
          <div id="balanceSummary" class="card p-2 mt-2 d-none"></div>

        </div>
      </div>

      <!-- Passo 4: Enviar tokens de teste -->
      <div class="card mb-3">
        <div class="card-header">
          <span><i class="bi bi-arrow-left-right me-2"></i>Passo 4: Enviar tokens de teste</span>
        </div>
        <div class="card-body">
          <label class="form-label">Quantidade a enviar:</label>
          <input id="sendAmountTokens" class="form-control mb-2" value="1000" placeholder="Ex.: 1000">
          <button id="sendTokens" class="btn btn-outline-primary w-100 mb-2">💸 Enviar Tokens de Teste para
            Sale</button>

        </div>
        <!-- Passo 5: Simular Função Payable -->
        <div class="card mb-3">
          <div class="card-header">
            <span><i class="bi bi-cash-stack me-2"></i>Passo 5: Simular função payable</span>
          </div>
          <div id="body-step-5" class="card-body">
            <select id="payableFunctions" class="form-select mb-2"></select>
            <label class="form-label">Preço por token (BNB):</label>
            <input id="buyTokenPrice" class="form-control mb-2" value="0.001" placeholder="Ex.: 0.001 BNB por token">
            <label class="form-label">Quantidade de tokens a comprar:</label>
            <input id="buyAmountTokens" class="form-control mb-2" value="100" placeholder="Ex.: 100">
            <label class="form-label">Valor em BNB a pagar (opcional):</label>
            <input id="bnbToPay" class="form-control mb-2" value="" placeholder="Ex.: 0.1">
            <button id="simulateBuy" class="btn btn-outline-info w-100 mb-2">💰 Simular Função Selecionada</button>

          </div>
        </div>

        <!-- Passo 6: Executar Compra -->
        <div class="card mb-3">
          <div class="card-header">
            <span><i class="bi bi-bag-check me-2"></i>Passo 6: Comprar (buy)</span>
          </div>
          <div id="body-step-6" class="card-body">
            <button id="executeBuy" class="btn btn-primary w-100 mb-2">🛒 Executar Compra (buy)</button>

          </div>
        </div>

        <!-- Log e Depuração -->
        <button id="showDebug" class="btn btn-secondary w-100 mb-3">🧠 Mostrar Log Completo</button>
        <pre id="log" class="card p-3"></pre>
        <div id="summary" class="card p-3 mt-2"></div>
        <div id="debugArea" class="card p-3 mt-2 d-none"></div>
      </div>
    </div>
  </div>

  <!-- Scripts Unificados -->
  <!-- Base System para carregamento de componentes -->
  <script type="module" src="../../../js/shared/base-system.js"></script>
  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <!-- Ethers.js (para Web3) -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

  <script type="text/plain" data-migrated="true">
const log = msg => { 
  const logEl = document.getElementById('log'); 
  logEl.textContent += msg + "\n"; 
  logEl.scrollTop = logEl.scrollHeight; 
  console.log(msg); 
};
// Declare globals and debug helpers
let provider, tokenAbi=null, saleAbi=null, signer;
const debugLog = [];
const addDebug = (label,data)=>{ debugLog.push({time:new Date().toISOString(),label,data}); console.debug(label,data); };
(function setupActionSequencer(){
  const getBtn = (id)=>document.getElementById(id);
  const setBtnEnabled = (id, enabled, reason='')=>{ const b=getBtn(id); if(!b) return; b.disabled = !enabled; if(!enabled && reason){ b.title = reason; } else { b.removeAttribute('title'); } const st=document.getElementById('status-'+id); if(st){ if(!enabled){ st.textContent='Aguardando: '+reason; st.className='step-status blocked mt-1'; } } };
  const setStepLabel = (id, num, label)=>{ const b=getBtn(id); if(!b) return; const base = b.textContent.replace(/^Passo\s*\d+\s*:\s*/,''); b.textContent = `Passo ${num}: ${label || base}`; };
  const safeAddr = (id)=>{ try{ return ethers.utils.getAddress((document.getElementById(id)?.value||'').trim()); }catch(_){ return null; } };
  const hasAbi = (abi)=> Array.isArray(abi) && abi.length>0;

  // Dar id ao botão de submit do formulário
  const submitBtn = document.querySelector('#checkerForm button[type="submit"]');
  if(submitBtn){ submitBtn.id = 'runChecksBtn'; }

  function applyStepLabels(){
    setStepLabel('connectWallet', 1, 'Conectar MetaMask');
    setStepLabel('runChecksBtn', 2, 'Carregar RPC e ABIs');
    setStepLabel('checkBalance', 3, 'Verificar saldos');
    setStepLabel('sendTokens', 4, 'Enviar tokens de teste');
    setStepLabel('simulateBuy', 5, 'Simular função payable');
    const buyBtn = getBtn('executeBuy'); if(buyBtn){ setStepLabel('executeBuy', 6, 'Comprar (buy)'); }
  }

  window.applySequencer = function applySequencer(){
    const rpcOk = !!provider;
    const signerOk = !!signer;
    const saleAddrOk = !!safeAddr('saleContract');
    const tokenAddrOk = !!safeAddr('tokenContract');
    const saleAbiOk = hasAbi(saleAbi);
    const tokenAbiOk = hasAbi(tokenAbi);
    const paySel = document.getElementById('payableFunctions');
    const payableOk = !!(paySel && paySel.options && paySel.options.length>0 && paySel.value);
    const bnbInput = document.getElementById('bnbToPay');
    const priceOk = parseFloat(document.getElementById('buyTokenPrice')?.value||'0')>0;
    const qtyOk = parseFloat(document.getElementById('buyAmountTokens')?.value||'0')>0;
    const bnbOk = bnbInput ? (parseFloat(bnbInput.value||'0')>0 || (priceOk && qtyOk)) : (priceOk && qtyOk);

    setBtnEnabled('connectWallet', true);
    setBtnEnabled('runChecksBtn', true);
    setBtnEnabled('checkBalance', (rpcOk && tokenAbiOk && saleAddrOk), 'Requer RPC, ABI Token e endereço Sale válido');
    setBtnEnabled('sendTokens', (signerOk && tokenAbiOk && saleAddrOk), 'Requer MetaMask, ABI Token, endereço Sale válido e saldo suficiente');
    setBtnEnabled('simulateBuy', (rpcOk && saleAbiOk && saleAddrOk && payableOk), 'Requer RPC, ABI Sale, endereço Sale e função selecionada');
    const buyBtn = getBtn('executeBuy'); if(buyBtn){ setBtnEnabled('executeBuy', (signerOk && saleAbiOk && tokenAbiOk && saleAddrOk && tokenAddrOk && bnbOk), 'Requer MetaMask, ABIs, endereços válidos e valor em BNB'); }
  };

  function wireReeval(){
    ['rpcUrl','tokenContract','saleContract','buyTokenPrice','buyAmountTokens','bnbToPay','payableFunctions','sendAmountTokens'].forEach(id=>{
      const el=document.getElementById(id); if(!el) return;
      const evt = (id==='payableFunctions') ? 'change' : 'input';
      el.addEventListener(evt, ()=>{ try{ applySequencer(); refreshBuyerBalanceStatus(); }catch(_e){} });
    });
    document.getElementById('checkerForm')?.addEventListener('submit', ()=>{ setTimeout(()=>{ try{ applySequencer(); refreshBuyerBalanceStatus(); }catch(_e){} }, 100); });
    document.getElementById('connectWallet')?.addEventListener('click', ()=>{ setTimeout(()=>{ try{ applySequencer(); refreshBuyerBalanceStatus(); }catch(_e){} }, 300); });
  }

  window.refreshBuyerBalanceStatus = async function(){
    const st = document.getElementById('status-sendTokens');
    const btn = document.getElementById('sendTokens');
    if(!st) return;
    if(!signer || !tokenAbi){ st.textContent = 'Aguardando: MetaMask e ABI Token'; st.className='step-status blocked mt-1'; return; }
    try{
      const tokenAddr = (document.getElementById('tokenContract')?.value||'').trim();
      const amountStr = (document.getElementById('sendAmountTokens')?.value||'1000').trim();
      const amountNum = parseFloat(amountStr);
      if(!(amountNum>0)){
        st.textContent = 'Aguardando: informe quantidade válida (> 0)';
        st.className = 'step-status blocked';
        if(btn){ btn.disabled = true; }
        return;
      }
      const prov = signer?.provider || provider;
      if(!prov){ st.textContent = 'Aguardando: RPC/MetaMask indisponível'; st.className='step-status blocked mt-1'; if(btn){ btn.disabled=true; } return; }
      const code = await prov.getCode(tokenAddr);
      addDebug('TokenCode-Step4', code);
      if(code === '0x'){
        st.textContent = 'Aguardando: contrato Token inexistente na rede atual';
        st.className='step-status blocked';
        if(btn){ btn.disabled=true; }
        return;
      }
      const token = new ethers.Contract(tokenAddr, tokenAbi, signer);
      const decimals = await token.decimals().catch(()=>18);
      const buyerAddr = await signer.getAddress();
      const bal = await token.balanceOf(buyerAddr);
      const amountUnits = ethers.utils.parseUnits(amountStr, decimals);
      const balFmt = ethers.utils.formatUnits(bal, decimals);
      const enough = bal.gte(amountUnits);
      st.textContent = enough ? `Sucesso: saldo ${balFmt}, enviar ${amountStr}` : `Aguardando: saldo suficiente (atual ${balFmt}, enviar ${amountStr})`;
      st.className = 'step-status ' + (enough ? 'ready' : 'blocked') + ' mt-1';
      if(btn){ btn.disabled = (!enough) || btn.disabled; }
    }catch(e){ st.textContent = 'Erro: ao ler saldo/decimais ('+e.message+')'; st.className='step-status blocked'; }
  }

  // inicializar sequenciador e status após carregamento
  applyStepLabels();
  wireReeval();
  setTimeout(()=>{ try{ applySequencer(); refreshBuyerBalanceStatus(); }catch(_e){} }, 50);

})();

// Mostrar/ocultar log completo
(document.getElementById('showDebug'))?.addEventListener('click', ()=>{
  const dbg = document.getElementById('debugArea');
  if (!dbg) return;
  dbg.classList.toggle('d-none');
  dbg.textContent = JSON.stringify(debugLog, null, 2);
});

// Testar RPC e carregar ABIs
async function testRPC(url){
  log('⏳ Conectando RPC...');
  try{
    provider = new ethers.providers.JsonRpcProvider(url);
    const net = await provider.getNetwork();
    addDebug('eth_chainId', net.chainId);
    log('✅ RPC ativo - ChainId: ' + net.chainId);
    return true;
  }catch(e){
    log('❌ Erro ao conectar RPC: ' + e.message);
    addDebug('RPC Error', e);
    return false;
  }
}

(document.getElementById('checkerForm'))?.addEventListener('submit', async (e)=>{
  e.preventDefault();
  const logEl = document.getElementById('log'); if (logEl) logEl.textContent = '';
  const sumEl = document.getElementById('summary'); if (sumEl) sumEl.textContent = '';
  debugLog.length = 0;
  const rpcUrl = document.getElementById('rpcUrl').value;
  const okRPC = await testRPC(rpcUrl);
  if(!okRPC){ if(sumEl){ sumEl.textContent = JSON.stringify({status:'RPC failed'},null,2); } return; }
  try{ tokenAbi = JSON.parse(document.getElementById('tokenAbiText').value); log('✅ ABI Token carregada'); }catch(e){ tokenAbi=null; log('⚠️ ABI Token inválida'); addDebug('Token ABI Parse Error', e); }
  try{ saleAbi = JSON.parse(document.getElementById('saleAbiText').value); log('✅ ABI Sale carregada'); }catch(e){ saleAbi=null; log('⚠️ ABI Sale inválida'); addDebug('Sale ABI Parse Error', e); }
  const payFuncs = saleAbi ? saleAbi.filter(f => f.type==='function' && f.stateMutability==='payable') : [];
  const sel = document.getElementById('payableFunctions'); if(sel){ sel.innerHTML=''; payFuncs.forEach(f=>{ const opt=document.createElement('option'); opt.value=f.name; opt.text=f.name+'('+f.inputs.map(i=>i.type).join(',')+')'; sel.appendChild(opt); }); }
  if(payFuncs.length>0){ log('✅ Funções payable detectadas: '+payFuncs.map(f=>f.name).join(', ')); } else { log('⚠️ Nenhuma função payable encontrada'); }
  if(sumEl){ sumEl.textContent = JSON.stringify({rpc:rpcUrl,tokenAbiLoaded:!!tokenAbi,saleAbiLoaded:!!saleAbi,payableFunctions:payFuncs.map(f=>f.name)},null,2); }
  const stRun = document.getElementById('status-runChecksBtn'); if(stRun){ stRun.textContent = 'Pronto'; stRun.className = 'step-status ready mt-1'; }
  setTimeout(()=>{ try{ applySequencer(); refreshBuyerBalanceStatus(); }catch(_e){} }, 100);
});

// Conectar MetaMask
(document.getElementById('connectWallet'))?.addEventListener('click', async ()=>{
  if(!window.ethereum){ alert('MetaMask não detectado'); return; }
  try{
    await window.ethereum.request({method:'eth_requestAccounts'});
    provider = new ethers.providers.Web3Provider(window.ethereum);
    signer = provider.getSigner();
    const addr = await signer.getAddress();
    log('👛 Conectado: ' + addr);
    addDebug('MetaMask',[addr]);
    const st = document.getElementById('status-connectWallet'); if(st){ st.textContent='Pronto'; st.className='step-status ready mt-1'; }
  }catch(e){ log('❌ Erro MetaMask: ' + e.message); addDebug('MetaMask Error', e); }
  setTimeout(()=>{ try{ applySequencer(); refreshBuyerBalanceStatus(); }catch(_e){} }, 300);
});

// Verificar saldo do contrato Sale
(document.getElementById('checkBalance'))?.addEventListener('click', async ()=>{
  if(!provider||!tokenAbi){ alert('Conecte RPC e carregue ABI Token'); return; }
  try{
    const tokenAddr=(document.getElementById('tokenContract').value||'').trim();
    const saleAddr=(document.getElementById('saleContract').value||'').trim();
    const code = await provider.getCode(tokenAddr);
    addDebug('TokenCode', code);
    if(code === '0x'){ log('⚠️ Código do contrato Token não encontrado no RPC. Verifique endereço e rede (ChainId 97).'); return; }
    const token = new ethers.Contract(tokenAddr, tokenAbi, provider);
    let decimals = 18; try{ decimals = await token.decimals(); }catch(decErr){ addDebug('DecimalsReadError', decErr); }
    const bal = await token.balanceOf(saleAddr);
    log(`📊 Saldo do contrato Sale: ${ethers.utils.formatUnits(bal,decimals)} SCAFE`);
    addDebug('Sale Balance', bal.toString());
    const st = document.getElementById('status-checkBalance'); if(st){ st.textContent = 'Pronto'; st.className = 'step-status ready mt-1'; }
  }catch(e){
    log('❌ Erro ao verificar saldo: ' + e.message);
    addDebug('Balance Error',e);
    if(e.code === 'CALL_EXCEPTION'){ log('💡 Dica: CALL_EXCEPTION indica revert ou contrato/ABI incompatíveis. Confirme endereço do token, rede (BSC Testnet 97) e ABI.'); log('🧭 Consulte: https://links.ethers.org/v5-errors-CALL_EXCEPTION'); }
  }
});

// Enviar tokens de teste
(document.getElementById('sendTokens'))?.addEventListener('click', async ()=>{
  if(!signer||!tokenAbi){ alert('Conecte MetaMask e carregue ABI Token'); return; }
  try{
    const tokenAddr=(document.getElementById('tokenContract').value||'').trim();
    const saleAddr=(document.getElementById('saleContract').value||'').trim();
    const prov = signer?.provider || provider;
    const code = await (prov ? prov.getCode(tokenAddr) : Promise.resolve('0x'));
    addDebug('TokenCode-Send', code);
    if(code === '0x'){ log('⚠️ Token não encontrado na rede atual (getCode=0x). Verifique endereço e rede.'); return; }
    const token = new ethers.Contract(tokenAddr, tokenAbi, signer);
    const decimals = await token.decimals().catch(()=>18);
    const amountStr = (document.getElementById('sendAmountTokens')?.value||'1000').trim();
    const amountNum = parseFloat(amountStr);
    if(!(amountNum>0)){ log('⚠️ Quantidade inválida. Informe um valor > 0.'); await refreshBuyerBalanceStatus(); return; }
    const amount = ethers.utils.parseUnits(amountStr, decimals);
    const buyerAddr = await signer.getAddress();
    const buyerBal = await token.balanceOf(buyerAddr);
    if(buyerBal.lt(amount)){ log(`⚠️ Saldo insuficiente do comprador: ${ethers.utils.formatUnits(buyerBal,decimals)} < ${amountStr}`); addDebug('BuyerBalance', buyerBal.toString()); await refreshBuyerBalanceStatus(); return; }
    const tx = await token.transfer(saleAddr, amount);
    log(`💸 Enviando ${amountStr} tokens para Sale...`);
    await tx.wait();
    log('✅ Tokens enviados com sucesso');
    addDebug('TransferTx', tx.hash);
    await refreshBuyerBalanceStatus();
  }catch(e){ log('❌ Erro ao enviar tokens: ' + e.message); addDebug('Transfer Error', e); }
});

// Executar compra
(document.getElementById('executeBuy'))?.addEventListener('click', async ()=>{
  if(!signer || !saleAbi){ alert('Conecte MetaMask e carregue ABI Sale'); return; }
  const sel=document.getElementById('payableFunctions');
  const funcName=sel?.value || 'buy';
  try{
    const saleAddr=document.getElementById('saleContract').value.trim();
    const tokenAddr=document.getElementById('tokenContract').value.trim();
    const sale = new ethers.Contract(saleAddr, saleAbi, signer);
    if (sale.destinationWallet) { const destWallet = await sale.destinationWallet(); if (destWallet === '0x0000000000000000000000000000000000000000') { log('⚠️ destinationWallet é endereço zero. Configure-a no contrato.'); return; } }
    if (sale.saleToken) { const saleTokenAddr = await sale.saleToken(); if (saleTokenAddr === '0x0000000000000000000000000000000000000000') { log('⚠️ saleToken não configurado (endereço zero).'); return; } }
    const token = new ethers.Contract(tokenAddr, tokenAbi, signer || provider);
    const decimals = await token.decimals().catch(()=>18);
    const priceStr = (document.getElementById('buyTokenPrice')?.value || '0').trim();
    const qtyStr = (document.getElementById('buyAmountTokens')?.value || '0').trim();
    const manualBnbStr = (document.getElementById('bnbToPay')?.value || '').trim();
    const qtyNum = parseFloat(qtyStr);
    const priceNum = parseFloat(priceStr);
    if (!(qtyNum > 0)) { log('⚠️ Informe quantidade de tokens > 0'); return; }
    const quantityUnits = ethers.utils.parseUnits(qtyStr, decimals);
    const buyAbiItem = Array.isArray(saleAbi) ? saleAbi.find(f => f.type === 'function' && f.name === 'buy') : null;
    const buyInputsCount = buyAbiItem?.inputs?.length || 0;
    let txValue = ethers.BigNumber.from(0);
    if (priceNum > 0) { const weiPerToken = ethers.utils.parseEther(priceStr); txValue = weiPerToken.mul(quantityUnits).div(ethers.BigNumber.from(10).pow(decimals)); }
    else if (sale.bnbPrice) { const pricePerUnit = await sale.bnbPrice(); txValue = pricePerUnit.mul(quantityUnits).div(ethers.BigNumber.from(10).pow(decimals)); }
    else { txValue = ethers.utils.parseEther('0.01'); }
    if (manualBnbStr) { const manualWei = ethers.utils.parseEther(manualBnbStr); if (!manualWei.eq(txValue)) { log(`ℹ️ Valor BNB informado (${manualBnbStr}) difere do calculado (${ethers.utils.formatEther(txValue)}). Usando calculado para execução.`); } }
    log(`🛒 Executando buy com qty=${qtyStr} tokens e value=${ethers.utils.formatEther(txValue)} BNB...`);
    const saleWithSigner = sale.connect(signer);
    let tx;
    if (funcName === 'buy' && buyInputsCount === 0) { tx = await saleWithSigner.buy({ value: txValue }); }
    else if (funcName === 'buy' && buyInputsCount >= 1) { tx = await saleWithSigner.buy(quantityUnits, { value: txValue }); }
    else { tx = await saleWithSigner[funcName]({ value: txValue }); }
    addDebug('BuyTxHash', tx.hash);
    const receipt = await tx.wait();
    log(`✅ Compra confirmada em bloco ${receipt.blockNumber}. Tx: ${tx.hash}`);
  }catch(e){
    log('❌ Erro ao executar compra: ' + e.message);
    addDebug('ExecuteBuy Error', e);
    if(e.code === 'UNPREDICTABLE_GAS_LIMIT'){ log('💡 Dica: A transação está revertendo. Verifique destinationWallet, saleToken, preço/quantidade e permissões.'); }
  }
  setTimeout(()=>{ try{ applySequencer(); }catch(_e){} }, 200);
});

// Simular função payable (estimateGas)
(document.getElementById('simulateBuy'))?.addEventListener('click', async ()=>{
  if(!provider || !saleAbi){ alert('Conecte RPC e carregue ABI Sale'); return; }
  const sel = document.getElementById('payableFunctions');
  const funcName = sel?.value || 'buy';
  try{
    const saleAddr = (document.getElementById('saleContract').value||'').trim();
    const tokenAddr = (document.getElementById('tokenContract').value||'').trim();
    const sale = new ethers.Contract(saleAddr, saleAbi, provider);
    const token = new ethers.Contract(tokenAddr, tokenAbi, signer || provider);
    const decimals = await token.decimals().catch(()=>18);
    const priceStr = (document.getElementById('buyTokenPrice')?.value || '0').trim();
    const qtyStr = (document.getElementById('buyAmountTokens')?.value || '0').trim();
    const manualBnbStr = (document.getElementById('bnbToPay')?.value || '').trim();
    const qtyNum = parseFloat(qtyStr);
    if(!(qtyNum>0)) { log('⚠️ Informe quantidade de tokens > 0'); return; }
    const quantityUnits = ethers.utils.parseUnits(qtyStr, decimals);
    const buyAbiItem = Array.isArray(saleAbi) ? saleAbi.find(f => f.type==='function' && f.name==='buy') : null;
    const buyInputsCount = buyAbiItem?.inputs?.length || 0;
    addDebug('BuyInputsCount', buyInputsCount);
    let txValue = ethers.BigNumber.from(0);
    if (priceStr && parseFloat(priceStr)>0) { const weiPerToken = ethers.utils.parseEther(priceStr); txValue = weiPerToken.mul(quantityUnits).div(ethers.BigNumber.from(10).pow(decimals)); }
    else if (sale.bnbPrice) { const pricePerUnit = await sale.bnbPrice(); txValue = pricePerUnit.mul(quantityUnits).div(ethers.BigNumber.from(10).pow(decimals)); }
    else if (manualBnbStr) { txValue = ethers.utils.parseEther(manualBnbStr); }
    else { txValue = ethers.utils.parseEther('0.01'); }
    addDebug('TxValueWei', txValue.toString());
    log(`🔍 Simulando ${funcName} com qty=${qtyStr} tokens e value=${ethers.utils.formatEther(txValue)} BNB...`);
    const iface = new ethers.utils.Interface(saleAbi);
    let data;
    if (funcName === 'buy' && buyInputsCount === 0) { data = iface.encodeFunctionData('buy', []); }
    else if (funcName === 'buy' && buyInputsCount >= 1) { data = iface.encodeFunctionData('buy', [quantityUnits]); }
    else { data = iface.encodeFunctionData(funcName, []); }
    const est = await provider.estimateGas({ to: saleAddr, from: signer ? await signer.getAddress() : undefined, data, value: txValue });
    log(`✅ estimateGas: ${est.toString()}`);
    addDebug('estimateGas', est.toString());
    const st = document.getElementById('status-simulateBuy'); if(st){ st.textContent = `OK: Gas ${est.toString()}`; st.className = 'step-status ok mt-1'; }
  }catch(e){
    log('❌ Erro estimateGas: ' + e.message);
    addDebug('EstimateGas Error',e);
    if(e.code === 'UNPREDICTABLE_GAS_LIMIT'){ log('💡 Dica: Transação pode reverter. Verifique destinationWallet, saleToken e parâmetros/valor.'); log('🧭 Consulte: https://links.ethers.org/v5-errors-UNPREDICTABLE_GAS_LIMIT'); }
    const st = document.getElementById('status-simulateBuy'); if(st){ st.textContent = 'Erro na simulação'; st.className = 'step-status blocked mt-1'; }
  }
  setTimeout(()=>{ try{ applySequencer(); }catch(_e){} }, 200);
});

</script>
  <script type="module" src="../../../js/modules/widget/widget_teste.js"></script>

</body>

</html>