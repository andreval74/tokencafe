<!doctype html>
<html lang="pt-BR">
  <head>
    <title>Mini Widget Config • TokenCafe</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Configuração e geração do Mini Widget de venda de tokens">
    <meta name="author" content="TokenCafe Team">

    <!-- Favicons TokenCafe -->
    <link rel="icon" type="image/png" sizes="16x16" href="../../../imgs/tkncafe16x16.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../../../imgs/tkncafe32x32.png">
    <link rel="icon" type="image/png" sizes="192x192" href="../../../imgs/tkncafe192x192.png">

    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <!-- TokenCafe CSS Unificado -->
    <link href="../../../css/styles.css" rel="stylesheet">
</head>
  <body class="bg-page-black">
    <!-- Header Unificado -->
    <div data-component="tools-header.html"
         data-icon="fa-rocket"
         data-icon-alt="Mini Widget"
         data-title="Mini Widget Config"
         data-subtitle="Configure e gere o seu widget"></div>

    <div class="container-fluid py-3 mb-1">
      <div class="row justify-content-center">
        <div class="col-lg-8 col-xl-6">
      <div class="card shadow-sm mb-4">
        <div class="card-body">
        <div class="d-flex align-items-center mb-2">
          <div class="me-2"><i class="bi bi-lightbulb text-warning"></i></div>
          <div class="flex-grow-1">
            <h5 class="mb-0">Como funciona</h5>
            <small class="text-muted">Passos rápidos para testar e validar</small>
          </div>
        </div>
        <div class="steps">
          <div class="step">1) Conectar a MetaMask</div>
          <div class="step">2) Trocar para a rede Testnet 97</div>
          <div class="step">3) Informar carteiras (oficial e comissão)</div>
          <div class="step">4) Validar saldos e estimativa</div>
          <div class="step">5) Enviar 0.0001 tBNB com divisão 95%/5%</div>
          <div class="step">6) Ver os hashes no BscScan</div>
        </div>
        </div>
      </div>

      <div class="card shadow-sm mb-4">
        <div class="card-body">
        <div class="d-flex align-items-center mb-2">
          <div class="me-2"><i class="bi bi-gear text-primary"></i></div>
          <div class="flex-grow-1">
            <h5 class="mb-0">Dados para o teste</h5>
            <small class="text-muted">Preencha rede, carteiras e limites</small>
          </div>
        </div>
        <!-- Linha 1: Modo simples e ChainId lado a lado -->
        <div class="row g-3 mb-3">
          <div class="col-md-6">
            <label for="simpleMode" class="form-label">Modo simples</label>
            <select id="simpleMode" class="form-select">
              <option value="on" selected>Ligado (campos avançados ocultos)</option>
              <option value="off">Desligado (mostrar avançados)</option>
            </select>
            <div class="form-text">Preencha só contrato, carteiras e limites</div>
          </div>
          <div class="col-md-6">
            <label for="chainIdDec" class="form-label">Rede (chainId decimal)</label>
            <input id="chainIdDec" type="number" min="1" step="1" value="97" class="form-control" />
            <div class="form-text">Ex.: 97 (BSC Testnet)</div>
          </div>
        </div>

        <!-- Linha 2: Busca de rede em largura total -->
        <div class="mb-3">
          <label for="networkSearch" class="form-label">
            <i class="bi bi-search me-2"></i>Buscar Rede Blockchain
          </label>
          <div class="position-relative">
            <input type="text" class="form-control form-control-lg" id="networkSearch"
              placeholder="Digite o nome da rede ou Chain ID (ex: Ethereum, Polygon, 1, 137)">
            <div id="networkAutocomplete" class="network-autocomplete position-absolute top-100 start-0 mt-1 w-100 d-none"></div>
          </div>
        </div>

        <!-- Linha 3: Método de pagamento e token ERC-20 lado a lado -->
        <div class="row g-3 mb-3">
          <div class="col-md-6">
            <label for="paymentMethod" class="form-label">Método de pagamento</label>
            <select id="paymentMethod" class="form-select">
              <option value="native" selected>BNB/tBNB nativo</option>
              <option value="erc20">Token ERC-20 (USDT/BUSD)</option>
            </select>
          </div>
          <div id="paymentTokenRow" class="col-md-6 d-none">
            <label for="paymentToken" class="form-label">Token de pagamento (ERC-20)</label>
            <input id="paymentToken" type="text" placeholder="0x…" class="form-control" />
          </div>
        </div>

        <!-- Linha 4: Mínimo, Máximo e Valor por token lado a lado -->
        <div class="row g-3 mb-3">
          <div class="col-md-4">
            <label for="minTokens" class="form-label">Quantidade mínima (tokens)</label>
            <input id="minTokens" type="number" min="0" step="any" placeholder="ex.: 100" class="form-control" />
          </div>
          <div class="col-md-4">
            <label for="maxTokens" class="form-label">Quantidade máxima (tokens)</label>
            <input id="maxTokens" type="number" min="0" step="any" placeholder="ex.: 1000" class="form-control" />
          </div>
          <div class="col-md-4">
            <label for="pricePerToken" class="form-label">Valor por token</label>
            <input id="pricePerToken" type="number" min="0" step="any" placeholder="ex.: 0.001" class="form-control" />
            <div class="form-text">Em BNB (nativo) ou USDT conforme o método</div>
          </div>
        </div>

        <!-- Linha 5: Disponível e Contrato lado a lado -->
        <div class="row g-3 mb-3">
          <div class="col-md-6">
            <label for="availableTokensText" class="form-label">Disponível (texto)</label>
            <input id="availableTokensText" type="text" placeholder="ex.: 1M Tokens" class="form-control" />
            <div class="form-text">Opcional, ex.: "1M Tokens"</div>
          </div>
          <div class="col-md-6">
            <label for="contractInput" class="form-label">Contrato de negociação</label>
            <input id="contractInput" type="text" placeholder="0x…" class="form-control" />
          </div>
        </div>

        <!-- Linha 6: Carteiras e percentuais lado a lado -->
        <div class="row g-3 mb-3">
          <div class="col-md-8">
            <label for="officialInput" class="form-label">Carteira oficial</label>
            <input id="officialInput" type="text" placeholder="0x…" value="0x0b81337F18767565D2eA40913799317A25DC4bc5" class="form-control" />
          </div>
          <div class="col-md-4">
            <label for="officialPct" class="form-label">Percentual oficial</label>
            <input id="officialPct" class="form-control" type="number" min="0" max="100" step="1" value="95" />
          </div>
        </div>
        <div class="row g-3 mb-3">
          <div class="col-md-8">
            <label for="commissionInput" class="form-label">Carteira de comissão</label>
            <input id="commissionInput" type="text" placeholder="0x…" value="0x2cf724171a998C3d470048AC2F1b187a48A5cafE" class="form-control" />
          </div>
          <div class="col-md-4">
            <label for="commissionPct" class="form-label">Percentual comissão</label>
            <input id="commissionPct" class="form-control" type="number" min="0" max="100" step="1" value="5" />
          </div>
        </div>

        <!-- Linha 7: Avançados em grid -->
        <div id="advancedSection" class="d-none">
          <div class="row g-3 mb-3">
            <div class="col-md-4">
              <label for="saleMethodSelector" class="form-label">Selector do método de venda</label>
              <input id="saleMethodSelector" type="text" placeholder="ex.: 0xabcdef12" class="form-control" />
              <div class="form-text">4 bytes (0x + 8 hex)</div>
            </div>
            <div class="col-md-4">
              <label for="saleId" class="form-label">Sale ID (opcional)</label>
              <input id="saleId" type="text" placeholder="0x… (bytes32)" class="form-control" />
            </div>
            <div class="col-md-4">
              <label for="purchasedOfSelector" class="form-label">Selector purchasedOf (opcional)</label>
              <input id="purchasedOfSelector" type="text" placeholder="ex.: 0x12345678" class="form-control" />
              <div class="form-text">4 bytes</div>
            </div>
          </div>
        </div>

        <!-- Linha 8: Ações em grid -->
        <div class="row g-2 mt-2">
          <div class="col-md-6 col-lg-3 d-grid">
            <button id="connectBtn" class="btn btn-primary">Conectar MetaMask</button>
          </div>
          <div class="col-md-6 col-lg-3 d-grid">
            <button id="validateBtn" class="btn btn-outline-secondary">Validar rede, carteiras e contrato</button>
          </div>
          <div class="col-md-6 col-lg-3 d-grid">
            <button id="sendBtn" class="btn btn-success" disabled>Enviar tBNB com divisão configurada</button>
          </div>
          <div class="col-md-6 col-lg-3 d-grid">
            <button id="generateCodeBtn" class="btn btn-outline-primary">Gerar widget-config.json</button>
          </div>
        </div>
        </div>
      </div>

      <div class="row g-3 mb-4">
        <div class="col-md-6">
          <div class="card shadow-sm h-100">
            <div class="card-body">
              <div class="d-flex align-items-center mb-2">
                <div class="me-2"><i class="bi bi-info-circle text-primary"></i></div>
                <div class="flex-grow-1"><h6 class="mb-0">Status</h6></div>
              </div>
              <div id="status" class="status"></div>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="card shadow-sm h-100">
            <div class="card-body">
              <div class="d-flex align-items-center mb-2">
                <div class="me-2"><i class="bi bi-wallet2 text-success"></i></div>
                <div class="flex-grow-1"><h6 class="mb-0">Saldos</h6></div>
              </div>
              <div id="balances" class="status"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="card shadow-sm mb-4">
        <div class="card-body">
          <div class="d-flex align-items-center mb-2">
            <div class="me-2"><i class="bi bi-activity text-warning"></i></div>
            <div class="flex-grow-1"><h5 class="mb-0">Resultado da transação</h5></div>
          </div>
          <div id="txResult" class="status"></div>
        </div>
      </div>

      <div class="card shadow-sm mb-4">
        <div class="card-body">
          <div class="d-flex align-items-center mb-2">
            <div class="me-2"><i class="bi bi-lightning-charge-fill text-warning"></i></div>
            <div class="flex-grow-1">
              <h5 class="mb-0">Visualização do Mini Widget</h5>
              <small class="text-muted">Abra a demonstração para validar visual e conexão</small>
            </div>
          </div>
          <div class="d-flex align-items-center gap-2 mt-0">
          <a class="icon-link" href="widget-demo.html" target="_blank" rel="noopener" title="Abrir Demo do Mini Widget">
            <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M14 3h7v7h-2V6.41l-7.29 7.3-1.42-1.42L17.59 5H14V3z"></path><path d="M5 5h7v2H7v10h10v-5h2v7H5V5z"></path></svg>
          </a>
          <a class="icon-link" href="widget-config.html" target="_blank" rel="noopener" title="Abrir Configuração">
            <svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M12 8a4 4 0 100 8 4 4 0 000-8zm8.94 5a7.98 7.98 0 00-.34-2l2.06-1.6-2-3.46-2.49.5a8.1 8.1 0 00-1.72-1l-.38-2.52H10.93l-.38 2.52a8.1 8.1 0 00-1.72 1l-2.49-.5-2 3.46L6.4 11a7.98 7.98 0 000 4l-2.06 1.6 2 3.46 2.49-.5c.53.39 1.12.72 1.72 1l.38 2.52h4.75l.38-2.52c.6-.28 1.19-.61 1.72-1l2.49.5 2-3.46L20.6 15c.15-.65.25-1.32.34-2z"></path></svg>
          </a>
          </div>
        </div>
      </div>

      
 
      
        </div>
      </div>
    </div>

    <script>
      const CHAIN_ID_DEC = 97;
      const CHAIN_ID_HEX = '0x61'; // 97 em hex

      const el = {
        officialInput: document.getElementById('officialInput'),
        commissionInput: document.getElementById('commissionInput'),
        officialPct: document.getElementById('officialPct'),
        commissionPct: document.getElementById('commissionPct'),
        chainIdDec: document.getElementById('chainIdDec'),
        paymentMethod: document.getElementById('paymentMethod'),
        paymentToken: document.getElementById('paymentToken'),
        minTokens: document.getElementById('minTokens'),
        maxTokens: document.getElementById('maxTokens'),
        pricePerToken: document.getElementById('pricePerToken'),
        availableTokensText: document.getElementById('availableTokensText'),
        contractInput: document.getElementById('contractInput'),
        saleMethodSelector: document.getElementById('saleMethodSelector'),
        saleId: document.getElementById('saleId'),
        purchasedOfSelector: document.getElementById('purchasedOfSelector'),
        connectBtn: document.getElementById('connectBtn'),
        validateBtn: document.getElementById('validateBtn'),
        sendBtn: document.getElementById('sendBtn'),
        status: document.getElementById('status'),
        balances: document.getElementById('balances'),
        txResult: document.getElementById('txResult'),
        // pré-visualização removida; usar widget-demo.html
        generateCodeBtn: document.getElementById('generateCodeBtn'),
      };

      let currentAccount = null;
      let currentChainIdHex = null;

      function getExplorerBase() {
        try {
          const dec = Number((el.chainIdDec.value || '').trim()) || CHAIN_ID_DEC;
          const nm = (window && window.networkManager) ? window.networkManager : null;
          const net = nm && typeof nm.getNetworkById === 'function' ? nm.getNetworkById(dec) : null;
          const url = (net && Array.isArray(net.explorers) && net.explorers[0]?.url) ? net.explorers[0].url : null;
          if (url) return url;
        } catch (_) {}
        return 'https://testnet.bscscan.com';
      }

      function updatePaymentVisibility() {
        const row = document.getElementById('paymentTokenRow');
        if (row) {
          const isErc20 = el.paymentMethod && el.paymentMethod.value === 'erc20';
          row.classList.toggle('d-none', !isErc20);
        }
        const adv = document.getElementById('advancedSection');
        const sm = document.getElementById('simpleMode');
        if (adv && sm) {
          const isSimple = sm.value === 'on';
          adv.classList.toggle('d-none', isSimple);
          if (isSimple && el.paymentMethod) el.paymentMethod.value = 'native';
        }
      }

      // Links removidos do formulário; nenhuma atualização necessária

      function getPercentages() {
        const off = Number((el.officialPct.value || '').trim());
        const com = Number((el.commissionPct.value || '').trim());
        if (!Number.isFinite(off) || !Number.isFinite(com)) return { ok: false, msg: 'Percentuais inválidos.' };
        if (off < 0 || com < 0 || off > 100 || com > 100) return { ok: false, msg: 'Percentuais devem estar entre 0 e 100.' };
        if (off + com !== 100) return { ok: false, msg: 'Percentuais devem somar 100.' };
        return { ok: true, off, com };
      }

      function fmtWeiToTBNB(hexWei) {
        const wei = BigInt(hexWei);
        const base = BigInt(10) ** BigInt(18);
        const whole = wei / base;
        const remainder = wei % base;
        const decimals = (remainder * BigInt(10000)) / base; // 4 casas
        return `${whole}.${decimals.toString().padStart(4, '0')} tBNB`;
      }

      function setStatus(msg, type = 'info') {
        const prefix = type === 'error' ? '❌ ' : type === 'success' ? '✅ ' : 'ℹ️ ';
        el.status.textContent = prefix + msg;
      }
      function setBalances(msg) { el.balances.textContent = msg; }
      function setTx(msgHtml) { el.txResult.innerHTML = msgHtml; }

      async function connectWallet() {
        if (!window.ethereum) { setStatus('MetaMask não detectada. Instale e recarregue a página.', 'error'); return; }
        try {
          const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
          currentAccount = accounts[0];
          currentChainIdHex = await window.ethereum.request({ method: 'eth_chainId' });
          setStatus(`Carteira conectada: ${currentAccount}\nChain atual (hex): ${currentChainIdHex}`);
        } catch (err) { setStatus(`Falha ao conectar: ${err.message}`, 'error'); }
      }

      function getChainHexFromInput() {
        const dec = Number((el.chainIdDec.value || '').trim()) || CHAIN_ID_DEC;
        return '0x' + dec.toString(16);
      }

      async function ensureChainFromInput() {
        try {
          const targetHex = getChainHexFromInput();
          await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: targetHex }] });
          currentChainIdHex = targetHex;
          setStatus(`Rede trocada com sucesso. chainId: ${targetHex}.`, 'success');
        } catch (switchError) {
          if (switchError && switchError.code === 4902) {
            try {
              const dec = Number((el.chainIdDec.value || '').trim()) || CHAIN_ID_DEC;
              const nm = (window && window.networkManager) ? window.networkManager : null;
              const net = nm && typeof nm.getNetworkById === 'function' ? nm.getNetworkById(dec) : null;
              if (!net) { throw new Error('Rede desconhecida. Adicione manualmente nas configurações da MetaMask.'); }
              const paramsByDec = {
                chainId: '0x' + dec.toString(16),
                chainName: net.name,
                nativeCurrency: net.nativeCurrency,
                rpcUrls: net.rpc || [],
                blockExplorerUrls: (net.explorers || []).map(e => e.url).filter(Boolean)
              };
              await window.ethereum.request({ method: 'wallet_addEthereumChain', params: [paramsByDec] });
              setStatus('Rede adicionada. Trocando…');
              await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: paramsByDec.chainId }] });
              currentChainIdHex = paramsByDec.chainId;
              setStatus('Rede trocada com sucesso.', 'success');
            } catch (addError) { throw addError; }
          } else { throw switchError; }
        }
      }

      function buildWidgetConfig() {
        const dec = Number((el.chainIdDec.value || '').trim()) || CHAIN_ID_DEC;
        const chainHex = '0x' + dec.toString(16);
        let net = null;
        try {
          const nm = (window && window.networkManager) ? window.networkManager : null;
          const n = nm && typeof nm.getNetworkById === 'function' ? nm.getNetworkById(dec) : null;
          if (n) {
            net = {
              chainName: n.name,
              nativeCurrency: n.nativeCurrency,
              rpcUrls: n.rpc || [],
              blockExplorerUrls: (n.explorers || []).map(e => e.url).filter(Boolean)
            };
          }
        } catch (_) {}
        const sm = document.getElementById('simpleMode');
        const simpleOn = sm && sm.value === 'on';
        const method = simpleOn ? 'native' : (el.paymentMethod ? el.paymentMethod.value : 'native');
        const paymentToken = (el.paymentToken ? (el.paymentToken.value || '').trim() : '');
        const minTokens = (el.minTokens ? (el.minTokens.value || '').trim() : '');
        const maxTokens = (el.maxTokens ? (el.maxTokens.value || '').trim() : '');
        const pricePerToken = (el.pricePerToken ? (el.pricePerToken.value || '').trim() : '');
        const availableTokensText = (el.availableTokensText ? (el.availableTokensText.value || '').trim() : '');
        const saleMethodSelector = (el.saleMethodSelector ? (el.saleMethodSelector.value || '').trim() : '');
        const saleId = (el.saleId ? (el.saleId.value || '').trim() : '');
        const purchasedOfSelector = (el.purchasedOfSelector ? (el.purchasedOfSelector.value || '').trim() : '');
        const officialAddr = (el.officialInput.value || '').trim();
        const commissionAddr = (el.commissionInput.value || '').trim();
        const pct = getPercentages();
        const cfg = {
          mount: '#mini-widget',
          title: 'Oferta Especial',
          ctaLabel: 'Comprar agora',
          chainId: chainHex,
          network: net || undefined,
          saleContract: (el.contractInput.value || '').trim(),
          purchaseUSDT: '10',
          purchaseTokens: '10',
          inputMode: method === 'native' ? 'bnb' : 'usdt',
          usdtAddress: method === 'erc20' && paymentToken ? paymentToken : '0x0000000000000000000000000000000000000000',
          usdtDecimals: 6,
          pricePerToken: pricePerToken || undefined,
          priceCurrency: method === 'native' ? 'BNB' : 'USDT',
          availableTokensText: availableTokensText || undefined,
          saleMethodSelector: saleMethodSelector || '0x00000000',
          saleTokenSymbol: 'TOK',
          minPurchaseTokens: minTokens || undefined,
          maxPurchaseTokens: maxTokens || undefined,
          maxPerWalletUSDT: undefined,
          maxPerWalletTokens: undefined,
          saleId: saleId || undefined,
          purchasedOfSelector: purchasedOfSelector || '0x00000000',
          officialWallet: officialAddr || undefined,
          commissionWallet: commissionAddr || undefined,
          officialPct: pct && pct.ok ? pct.off : undefined,
          commissionPct: pct && pct.ok ? pct.com : undefined
        };
        return cfg;
      }

      // Geração de arquivo de configuração (download)
      function generateConfigFile() {
        try {
          const cfg = buildWidgetConfig();
          const blob = new Blob([JSON.stringify(cfg, null, 2)], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'widget-config.json';
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
          setStatus('Arquivo widget-config.json gerado para download.', 'success');
        } catch (e) {
          setStatus('Falha ao gerar arquivo de configuração: ' + (e && e.message ? e.message : e), 'error');
        }
      }

      // pré-visualização inline removida; utilize a página widget-demo.html

      function isValidAddress(addr) { return /^0x[a-fA-F0-9]{40}$/.test(addr); }

      async function fetchBalances(officialAddr, commissionAddr) {
        try {
          const acctBalHex = await window.ethereum.request({ method: 'eth_getBalance', params: [currentAccount, 'latest'] });
          const offBalHex = await window.ethereum.request({ method: 'eth_getBalance', params: [officialAddr, 'latest'] });
          const comBalHex = await window.ethereum.request({ method: 'eth_getBalance', params: [commissionAddr, 'latest'] });
          const msg = [
            `Saldo da conta: ${fmtWeiToTBNB(acctBalHex)}`,
            `Saldo carteira oficial: ${fmtWeiToTBNB(offBalHex)}`,
            `Saldo carteira comissão: ${fmtWeiToTBNB(comBalHex)}`,
          ].join('\n');
          setBalances(msg);
        } catch (err) { setStatus(`Falha ao obter saldos: ${err.message}`, 'error'); }
      }

      async function validateNetworkAndWallets() {
        if (!window.ethereum) { setStatus('MetaMask não detectada.', 'error'); return; }
        if (!currentAccount) { await connectWallet(); if (!currentAccount) return; }
        const officialAddr = (el.officialInput.value || '').trim();
        const commissionAddr = (el.commissionInput.value || '').trim();
        if (!isValidAddress(officialAddr) || !isValidAddress(commissionAddr)) { setStatus('Endereço de carteira inválido.', 'error'); return; }
        const pct = getPercentages();
        if (!pct.ok) { setStatus(pct.msg, 'error'); return; }
        try {
          await ensureChainFromInput();
          await fetchBalances(officialAddr, commissionAddr);
          const method = (el.paymentMethod ? el.paymentMethod.value : 'native');
          let validationMsg = '';
          if (method === 'native') {
            const base = BigInt(100_000_000_000_000); // 0.0001 tBNB em wei
            const offValue = '0x' + (base * BigInt(pct.off) / BigInt(100)).toString(16);
            const comValue = '0x' + (base * BigInt(pct.com) / BigInt(100)).toString(16);
            let gasOff, gasCom;
            try {
              gasOff = await window.ethereum.request({ method: 'eth_estimateGas', params: [{ from: currentAccount, to: officialAddr, value: offValue }] });
            } catch (e) {
              gasOff = 'erro: ' + (e && e.message ? e.message : String(e));
            }
            try {
              gasCom = await window.ethereum.request({ method: 'eth_estimateGas', params: [{ from: currentAccount, to: commissionAddr, value: comValue }] });
            } catch (e) {
              gasCom = 'erro: ' + (e && e.message ? e.message : String(e));
            }
            // Checar contrato de negociação para recepção de tBNB
            const contractAddr = (el.contractInput.value || '').trim();
            let contractValidation = '';
            if (contractAddr) {
              if (!isValidAddress(contractAddr)) {
                contractValidation = 'Contrato de negociação inválido.';
              } else {
                const code = await window.ethereum.request({ method: 'eth_getCode', params: [contractAddr, 'latest'] });
                if (!code || code === '0x') {
                  contractValidation = 'O endereço informado não é um contrato.';
                } else {
                  // Evitar chamar eth_estimateGas direto ao contrato sem ABI para reduzir erros -32603 no console
                  // Em vez disso, informamos que a validação não testa envio de tBNB ao contrato
                  contractValidation = 'Contrato encontrado. Não validamos envio direto de tBNB sem ABI. Se o contrato tiver payable/receive, use o teste de transação ou o fluxo do contrato de venda.';
                }
              }
            }
            validationMsg = `Validação ok. Gas estimado:\nCarteira oficial (${pct.off}%): ${gasOff}\nCarteira comissão (${pct.com}%): ${gasCom}${contractValidation ? `\n${contractValidation}` : ''}`;
            el.sendBtn.disabled = false; // envio de tBNB habilitado
          } else {
            // ERC-20: validar token, saldo e allowance
            const paymentToken = (el.paymentToken ? (el.paymentToken.value || '').trim() : '');
            if (!isValidAddress(paymentToken)) { setStatus('Token de pagamento inválido.', 'error'); return; }
            const code = await window.ethereum.request({ method: 'eth_getCode', params: [paymentToken, 'latest'] });
            if (!code || code === '0x') { setStatus('Token de pagamento não é contrato.', 'error'); return; }
            const SEL = { symbol:'0x95d89b41', decimals:'0x313ce567', balanceOf:'0x70a08231', allowance:'0xdd62ed3e' };
            const pad32 = (addr) => addr.toLowerCase().replace('0x','').padStart(64,'0');
            let decHex;
            let balHex;
            try {
              decHex = await window.ethereum.request({ method: 'eth_call', params: [{ to: paymentToken, data: SEL.decimals }, 'latest'] });
            } catch (e) {
              setStatus(`Falha ao consultar decimals do token: ${e && e.message ? e.message : 'erro -32603'}`, 'error');
              return;
            }
            try {
              balHex = await window.ethereum.request({ method: 'eth_call', params: [{ to: paymentToken, data: SEL.balanceOf + pad32(currentAccount) }, 'latest'] });
            } catch (e) {
              setStatus(`Falha ao consultar balanceOf: ${e && e.message ? e.message : 'erro -32603'}`, 'error');
              return;
            }
            const decimals = Number(BigInt(decHex || '0x0'));
            const balance = BigInt(balHex || '0x0');
            const saleContract = (el.contractInput.value || '').trim();
            let allowMsg = '';
            if (isValidAddress(saleContract)) {
              try {
                const allowHex = await window.ethereum.request({ method: 'eth_call', params: [{ to: paymentToken, data: SEL.allowance + pad32(currentAccount) + pad32(saleContract) }, 'latest'] });
                const allowance = BigInt(allowHex || '0x0');
                allowMsg = `Allowance para contrato de venda: ${allowance.toString()}`;
              } catch (e) {
                allowMsg = `Falha ao consultar allowance: ${e && e.message ? e.message : 'erro -32603'} (tratado)`;
              }
            } else {
              allowMsg = 'Contrato de venda não informado ou inválido para checar allowance.';
            }
            // Limites de compra (opcionais)
            const rawMin = (el.minTokens && el.minTokens.value || '').trim();
            const rawMax = (el.maxTokens && el.maxTokens.value || '').trim();
            let limitsMsg = '';
            if (rawMin || rawMax) {
              const minTok = rawMin ? Number(rawMin) : NaN;
              const maxTok = rawMax ? Number(rawMax) : NaN;
              if (rawMin && (!Number.isFinite(minTok) || minTok <= 0)) { setStatus('Valor mínimo de tokens inválido (deve ser > 0).', 'error'); return; }
              if (rawMax && rawMin && Number.isFinite(minTok) && Number.isFinite(maxTok) && maxTok < minTok) { setStatus('Valor máximo deve ser maior ou igual ao mínimo.', 'error'); return; }
              const minTxt = rawMin ? `mín ${minTok}` : 'mín não definido';
              const maxTxt = rawMax ? `máx ${maxTok}` : 'máx não definido';
              limitsMsg = `\nLimites de compra: ${minTxt}; ${maxTxt}`;
            }
            validationMsg = `Token ERC-20 válido. Decimals: ${decimals}\nSaldo do usuário: ${balance.toString()}\n${allowMsg}${limitsMsg}\nObservação: modo de teste não envia ERC-20; use o contrato de venda.`;
            el.sendBtn.disabled = true; // no modo ERC-20 não enviamos tBNB
          }
          setStatus(validationMsg, 'success');
        } catch (err) { setStatus(`Validação falhou: ${err.message}`, 'error'); }
      }

      async function sendTestTransaction() {
        if (!window.ethereum) { setStatus('MetaMask não detectada.', 'error'); return; }
        if (!currentAccount) { await connectWallet(); if (!currentAccount) return; }
        const method = (el.paymentMethod ? el.paymentMethod.value : 'native');
        if (method === 'erc20') { setStatus('Modo ERC-20 selecionado. Este teste envia apenas tBNB. Realize a compra via contrato ERC-20.', 'info'); return; }
        const officialAddr = (el.officialInput.value || '').trim();
        const commissionAddr = (el.commissionInput.value || '').trim();
        if (!isValidAddress(officialAddr) || !isValidAddress(commissionAddr)) { setStatus('Endereço de carteira inválido.', 'error'); return; }
        const pct = getPercentages();
        if (!pct.ok) { setStatus(pct.msg, 'error'); return; }
        try {
          await ensureChainFromInput();
          const base = BigInt(100_000_000_000_000); // 0.0001 tBNB em wei
          const offValue = '0x' + (base * BigInt(pct.off) / BigInt(100)).toString(16);
          const comValue = '0x' + (base * BigInt(pct.com) / BigInt(100)).toString(16);
          const explorer = getExplorerBase() + '/tx/';
          const txHashOff = await window.ethereum.request({ method: 'eth_sendTransaction', params: [{ from: currentAccount, to: officialAddr, value: offValue }] });
          const txHashCom = await window.ethereum.request({ method: 'eth_sendTransaction', params: [{ from: currentAccount, to: commissionAddr, value: comValue }] });
          setTx(`Transações enviadas!
Oficial (${pct.off}%): <a href="${explorer}${txHashOff}" target="_blank" class="monospace">${txHashOff}</a>
Comissão (${pct.com}%): <a href="${explorer}${txHashCom}" target="_blank" class="monospace">${txHashCom}</a>`);
          setStatus('Transações de teste enviadas com sucesso.', 'success');
          await fetchBalances(officialAddr, commissionAddr);
        } catch (err) { setStatus(`Envio falhou: ${err.message}`, 'error'); }
      }

      function clampPct(n) {
        let v = Number(n);
        if (!Number.isFinite(v)) v = 0;
        if (v < 0) v = 0;
        if (v > 100) v = 100;
        return Math.round(v);
      }
      // Removidas ligações de atualização de links
      ['input','change'].forEach(ev => {
        el.officialPct.addEventListener(ev, () => { const v = clampPct(el.officialPct.value); el.officialPct.value = v; el.commissionPct.value = 100 - v; });
        el.commissionPct.addEventListener(ev, () => { const v = clampPct(el.commissionPct.value); el.commissionPct.value = v; el.officialPct.value = 100 - v; });
      });
      el.paymentMethod && el.paymentMethod.addEventListener('change', updatePaymentVisibility);
      el.connectBtn.addEventListener('click', connectWallet);
      el.validateBtn.addEventListener('click', validateNetworkAndWallets);
      el.sendBtn.addEventListener('click', sendTestTransaction);
      // pré-visualização removida; sem evento
      el.generateCodeBtn && el.generateCodeBtn.addEventListener('click', generateConfigFile);
      document.getElementById('simpleMode') && document.getElementById('simpleMode').addEventListener('change', updatePaymentVisibility);
      // Removido botão de copiar código
      /*
      el.copyCodeBtn && el.copyCodeBtn.addEventListener('click', async () => {
        try {
          await navigator.clipboard.writeText(el.codeOutput.value || '');
          setStatus('Código copiado para a área de transferência.', 'success');
        } catch (e) { setStatus('Falha ao copiar código.', 'error'); }
      });
      */
      // Sincroniza percentuais inicialmente
      el.commissionPct.value = clampPct(100 - clampPct(el.officialPct.value));
      updatePaymentVisibility();
      // pré-visualização inline removida; use widget-demo.html
    </script>
      
      <!-- Network Manager + módulo do widget -->
      <script type="module" src="../../../js/modules/widget/widget_config.js"></script>
      <!-- Base System para componentes -->
      <script type="module" src="../../../js/shared/base-system.js"></script>
      <!-- Bootstrap JS -->
      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>