<!--
================================================================================
TOOLS HEADER - COMPONENTE PADRÃO PARA PÁGINAS DE FERRAMENTAS
================================================================================
Componente simples de brand (ícone, título, subtítulo) sem script na página receptora.
Uso: <div data-component="tools-header.html" data-icon="..." data-title="..." data-subtitle="..."></div>
As variáveis são declaradas via atributos data- no elemento onde o componente é incluído.
================================================================================
-->

<nav class="navbar navbar-expand-lg navbar-dark bg-page-black">
  <div class="container">
    <div class="tc-tools-header navbar-brand d-flex align-items-center">
      <a href="/pages/tools.html" class="d-flex align-items-center text-decoration-none">
        <!-- Logo fixa do TokenCafe -->
        <img id="tools-header-logo" src="/imgs/tkncafe-semfundo.png" alt="TokenCafe" class="logo-small me-3" />
      </a>
      <div>
        <h3 class="mb-0 text-white">
          <!-- Ícone dinâmico por página -->
          <i id="tools-system-icon" class="fas me-2" aria-label=""></i>
          <span id="tools-header-title">TokenCafe Tools</span>
        </h3>
        <p class="text-white-50 mb-0 small" id="tools-header-subtitle">Hub Central de Ferramentas Web3</p>
      </div>
    </div>

    <!-- Status da Carteira (padrão minimalista) -->
    <div class="d-flex flex-column align-items-end text-end">
      <div class="d-flex align-items-center">
        <!-- Mostra somente o número da carteira em verde quando conectado -->
        <span id="wallet-address" class="badge bg-success me-2 d-none">
          <i class="fas fa-check me-1"></i>
          <span id="wallet-address-text"></span>
        </span>

        <!-- Quando desconectado, mostra "Conectar" no lugar -->
        <button id="btn-connect" class="badge bg-warning me-2">
          <i class="fas fa-wallet me-1"></i>
          Conectar
        </button>

        <!-- botão de sair -->
        <button id="btn-logout" class="badge bg-danger me-2">
          <i class="fas fa-sign-out-alt me-1"></i>
          Sair
        </button>
      </div>
      <small id="device-note" class="mt-1"></small>
    </div>
  </div>
</nav>
    <div class="section-divider"></div>

<script>
  // Preenche ícone (dinâmico), título e subtítulo lendo os atributos data- do container do componente
  (function () {
    try {
      const containers = document.querySelectorAll('[data-component="tools-header.html"]');
      containers.forEach(el => {
        const iconClass = el.dataset.icon; // ex: 'fa-wallet'
        const iconAlt = el.dataset.iconAlt || '';
        const title = el.dataset.title;
        const subtitle = el.dataset.subtitle;

        // Logo fixa
        const logoEl = el.querySelector('#tools-header-logo');
        // Ícone dinâmico
        const sysIconEl = el.querySelector('#tools-system-icon');
        const titleEl = el.querySelector('#tools-header-title');
        const subtitleEl = el.querySelector('#tools-header-subtitle');
        
        // Logo: permanece fixa, não depende de data-attributes
        if (logoEl && !logoEl.src) {
          logoEl.src = '../imgs/tkncafe-semfundo.png';
        }
        if (logoEl && !logoEl.alt) {
          logoEl.alt = 'TokenCafe';
        }

        // Ícone dinâmico (FontAwesome)
        if (sysIconEl && iconClass) {
          sysIconEl.className = `fas ${iconClass} me-2`;
          if (iconAlt) sysIconEl.setAttribute('aria-label', iconAlt);
        }

        if (titleEl && title) titleEl.textContent = title;
        if (subtitleEl && subtitle) subtitleEl.textContent = subtitle;

        // ----- Integração de carteira no header -----
        const addrEl = el.querySelector('#wallet-address');
        const addrText = el.querySelector('#wallet-address-text');
        const btnConnect = el.querySelector('#btn-connect');
        const btnLogout = el.querySelector('#btn-logout');

        // Vincular UI de status usando helper global
        if (window.bindWalletStatusUI) {
          window.bindWalletStatusUI({
            addressEl: addrText,
            statusWrapperEl: addrEl,
            connectBtnEl: btnConnect
          });
        }

        // Clique de conectar
        if (btnConnect) {
          btnConnect.addEventListener('click', async (e) => {
            e.preventDefault();
            try {
              if (window.walletConnector && typeof window.walletConnector.connect === 'function') {
                await window.walletConnector.connect('metamask');
              } else {
                alert('Conector de carteira indisponível. Verifique scripts base.');
              }
            } catch (err) {
              console.warn('tools-header: falha ao conectar carteira', err);
              alert('Erro ao conectar carteira: ' + (err?.message || err));
            }
          }, { capture: true });
        }

        // Clique de sair e volta para index.html principal
        if (btnLogout) {
          btnLogout.addEventListener('click', async () => {
            try { await window.walletConnector?.disconnect?.(); } catch (e) { /* ignore */ }
            try { window.location.href = '/pages/index.html'; } catch (e) { /* ignore */ }
          });
        }
      });

      // Auto-conexão ao carregar páginas de módulo: garante prompt imediato
      (async function autoConnectOnModulePage(){
        try {
          const wc = window.walletConnector;
          if (wc && typeof wc.isConnected === 'function') {
            const already = await wc.isConnected();
            if (already) return;
          }
          if (!window.__tokencafe_auto_connect_initiated) {
            window.__tokencafe_auto_connect_initiated = true;
            if (typeof window.connectWallet === 'function') {
              await window.connectWallet();
            } else if (wc && typeof wc.connect === 'function') {
              await wc.connect('metamask');
            }
          }
        } catch (e) {
          console.warn('tools-header: falha na auto-conexão de módulo', e);
        }
      })();

    } catch (e) {
      console.warn('tools-header: falha ao popular variáveis', e);
    }
  })();
</script>

<script>
  // Aviso de dispositivo e bloqueio de menus no mobile
  (function () {
    try {
      const noteEl = document.getElementById('device-note');
      const ua = navigator.userAgent || navigator.vendor || window.opera;
      const isCoarse = window.matchMedia && window.matchMedia('(pointer: coarse)').matches;
      const isMobileUA = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(ua);
      const isSmallViewport = window.innerWidth <= 768;
      const isMobile = Boolean(isMobileUA || (isCoarse && isSmallViewport));

      if (noteEl) {
        noteEl.classList.remove('text-success', 'text-danger');
        if (isMobile) {
          noteEl.textContent = 'FALHA: sistema desenvolvido para DESKTOP';
          noteEl.classList.add('text-danger');
        } else {
          noteEl.textContent = 'sistema desenvolvido para DESKTOP';
          noteEl.classList.add('text-success');
        }
      }

      // Caso mobile, desabilitar menus e botões interativos
      if (isMobile) {
        const interactiveSelectors = [
          '.tool-tile', '.tool-link', '.nav-link', '.dropdown-item', 'a.btn', 'button.btn'
        ];
        const interactiveEls = document.querySelectorAll(interactiveSelectors.join(','));
        interactiveEls.forEach(el => {
          // Visual e acessibilidade
          el.classList.add('disabled');
          el.setAttribute('aria-disabled', 'true');
          el.setAttribute('tabindex', '-1');
          // Bloqueio de interação
          el.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
          }, true);
        });

        // Aplicar overlay cinza nos tiles principais
        document.querySelectorAll('.tool-tile, .tool-link').forEach(el => {
          el.classList.add('admin-disabled');
        });
      }
    } catch (e) {
      console.warn('tools-header: falha ao configurar aviso de dispositivo', e);
    }
  })();
</script>